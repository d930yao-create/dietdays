<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BowBow Calorie Savings</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg-color: #FDFBF7;
  --card-bg: #FFFFFF;
  --text-main: #6D5D50;
  --text-light: #9C8C74;
  --accent: #DBC8B6;
  --accent-hover: #C9B29C;
  --gold: #D4AF37; /* é”æˆç›®æ¨™çš„é‡‘ */
  --input-bg: #F7F3EF;
  --border-radius: 16px;
}

body {
  margin: 0;
  font-family: 'Noto Sans TC', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-main);
  padding: 20px;
  min-height: 100vh;
  box-sizing: border-box;
}

h2 {
  font-family: 'DM Serif Display', serif;
  color: var(--text-main);
  margin-top: 0;
  margin-bottom: 20px;
  font-size: 22px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1.2fr 1fr 0.8fr; /* ç¬¬ä¸€æ¬„ç¨å¾®å¯¬ä¸€é»çµ¦å„²è“„ç½ */
  gap: 24px;
}

@media (max-width: 900px) {
  .container { grid-template-columns: 1fr; }
}

.card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 24px;
  box-shadow: 0 4px 20px rgba(109, 93, 80, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.6);
  display: flex;
  flex-direction: column;
}

label {
  font-size: 11px;
  color: var(--text-light);
  letter-spacing: 1px;
  margin-bottom: 4px;
  display: block;
  text-transform: uppercase;
  font-weight: 600;
}

input {
  width: 100%;
  padding: 10px 14px;
  margin-bottom: 12px;
  border-radius: 12px;
  border: none;
  background: var(--input-bg);
  color: var(--text-main);
  font-size: 14px;
  box-sizing: border-box;
}

input:disabled {
    background: transparent;
    border: 1px dashed #E0D6CC;
    color: var(--text-light);
}

button {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: var(--accent);
  color: #fff;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.3s;
  font-weight: 500;
}
button:hover { background: var(--accent-hover); }

/* --- å„²è“„ç½å°ˆå€æ¨£å¼ --- */
.savings-box {
    background: #FDF9F3;
    border: 1px solid #EFE4D6;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
}

.goal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 10px;
}
.goal-title { font-size: 14px; font-weight: bold; color: var(--text-main); }
.goal-nums { font-size: 12px; color: var(--text-light); }
.goal-nums span { color: var(--accent-hover); font-weight: bold; font-size: 16px; }

.big-progress-bg {
    background: #EBE5DE;
    height: 14px;
    border-radius: 99px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
.big-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #DBC8B6, #D4AF37); /* æ¼¸å±¤é‡‘ */
    width: 0%;
    transition: width 1s ease-out;
}
.progress-badge {
    text-align: right;
    font-size: 11px;
    margin-top: 5px;
    color: var(--text-light);
}

/* æ¯æ—¥è¨ˆç®—å€ */
.daily-calc {
    border-top: 1px dashed #E0D6CC;
    padding-top: 15px;
}
.row-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
.cal-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 14px;
}
.cal-row.total {
    font-weight: bold;
    color: var(--text-main);
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
}

/* ç´€éŒ„åˆ—è¡¨ */
.record-list {
    flex: 1;
    overflow-y: auto;
    max-height: 400px;
    padding-right: 5px;
}
.record-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px dashed #EBE5DE;
    font-size: 13px;
}
.delete-btn { width: auto; background: none; color: #ccc; padding: 0 5px; }

/* Loading */
#loading {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(255,255,255,0.8);
    display: none; justify-content: center; align-items: center; z-index: 99;
    color: var(--accent);
}
</style>
</head>
<body>

<div id="loading">Syncing...</div>

<div class="container">
    
    <div class="card">
        <h2>Savings Bank</h2>
        
        <div class="row-split">
            <div>
                <label>åˆå§‹é«”é‡ (Start)</label>
                <input type="number" id="startWeight" value="77" onchange="calcTotalGoal()">
            </div>
            <div>
                <label>ç›®æ¨™é«”é‡ (Goal)</label>
                <input type="number" id="targetWeight" value="55" style="font-weight:bold; color:var(--text-main);" onchange="calcTotalGoal()">
            </div>
        </div>

        <div class="savings-box">
            <div class="goal-header">
                <div class="goal-title">ğŸ”¥ ç‡ƒç‡’é€²åº¦</div>
                <div class="goal-nums">
                    å·²å­˜ <span id="savedCal">0</span> / <span id="totalGoalCal">0</span> kcal
                </div>
            </div>
            <div class="big-progress-bg">
                <div class="big-progress-fill" id="longTermProgress"></div>
            </div>
            <div class="progress-badge" id="longTermPercent">0% å®Œæˆ</div>
            <p style="font-size:11px; color:var(--text-light); margin-top:8px; line-height:1.4;">
                *é‚è¼¯ï¼šæ¸›å»1å…¬æ–¤éœ€æ¶ˆè€— 7700 kcalã€‚<br>
                é€²åº¦æ¢æœƒæ ¹æ“šä½ æ¯å¤© (TDEE - æ”å–) çš„èµ¤å­—ç´¯ç©ã€‚
            </p>
        </div>

        <div class="daily-calc">
            <div class="row-split">
                <div>
                    <label>æ¯æ—¥ TDEE (ä»£è¬)</label>
                    <input type="number" id="tdee" value="1600" placeholder="åŸºç¤ä»£è¬" onchange="updateDailyAndSave()">
                </div>
                <div>
                    <label>ä»Šæ—¥å·²åƒ</label>
                    <input type="number" id="todayEaten" value="0" disabled>
                </div>
            </div>
            <div class="cal-row total">
                <span>ä»Šæ—¥å­˜æ¬¾ (Deficit)</span>
                <span id="todayDeficit">0</span>
            </div>
            <div style="font-size:11px; color:#aaa; margin-top:4px;">æ­£æ•¸ä»£è¡¨ä»Šæ—¥è®Šç˜¦ï¼Œè² æ•¸ä»£è¡¨è®Šèƒ–</div>
        </div>
    </div>

    <div class="card">
        <h2>Add Food</h2>
        <label>Food Name</label>
        <input type="text" id="foodName" placeholder="è¼¸å…¥é£Ÿç‰©åç¨±" onblur="autoSearch()">
        
        <label>Calories</label>
        <input type="number" id="foodCal" placeholder="kcal">
        
        <button onclick="addRecord()">ï¼‹ Add Record</button>
        <button onclick="googleSearch()" style="background:transparent; color:#999; border:1px solid #eee; margin-top:10px;">ğŸ” Google Check</button>
    </div>

    <div class="card">
        <h2>History</h2>
        <div class="record-list" id="recordList">Loading...</div>
    </div>

</div>

<script>
// ğŸ”¥ è«‹å°‡ä½ çš„ Web App URL è²¼åœ¨é€™è£¡
const API_URL = "https://script.google.com/macros/s/AKfycbzs4l4E4kxTxxBicnuHSgKo7zb1gMyC-hBnHKBoFW9Hpol1kOuQM8cc32C34fjXepiy/exec";

// UI Elements
const els = {
    startW: document.getElementById('startWeight'),
    targetW: document.getElementById('targetWeight'),
    tdee: document.getElementById('tdee'),
    savedCal: document.getElementById('savedCal'),
    totalGoalCal: document.getElementById('totalGoalCal'),
    longTermProgress: document.getElementById('longTermProgress'),
    longTermPercent: document.getElementById('longTermPercent'),
    todayEaten: document.getElementById('todayEaten'),
    todayDeficit: document.getElementById('todayDeficit'),
    foodName: document.getElementById('foodName'),
    foodCal: document.getElementById('foodCal'),
    recordList: document.getElementById('recordList'),
    loading: document.getElementById('loading')
};

// 1. åˆå§‹åŒ–èˆ‡è®€å–è¨­å®š
function init() {
    const saved = JSON.parse(localStorage.getItem('bowbow_settings'));
    if (saved) {
        els.startW.value = saved.startW || 77;
        els.targetW.value = saved.targetW || 55;
        els.tdee.value = saved.tdee || 1600;
    }
    calcTotalGoal();
    loadRecords(); // é€™è£¡ä¹Ÿæœƒé †ä¾¿è§¸ç™¼ totalSaved çš„è¨ˆç®—
}

// 2. è¨ˆç®—ç¸½ç›®æ¨™ç†±é‡ (å›ºå®šç›®æ¨™)
function calcTotalGoal() {
    const start = parseFloat(els.startW.value);
    const target = parseFloat(els.targetW.value);
    
    // å…¬å¼ï¼šå…¬æ–¤å·® * 7700
    let diff = start - target;
    if (diff < 0) diff = 0; // é˜²æ­¢ç›®æ¨™æ¯”ç¾åœ¨é‡
    
    const totalCalNeeded = Math.round(diff * 7700);
    els.totalGoalCal.textContent = totalCalNeeded.toLocaleString();
    
    saveSettings();
    return totalCalNeeded;
}

// 3. å„²å­˜è¨­å®šåˆ°æœ¬åœ°
function saveSettings() {
    localStorage.setItem('bowbow_settings', JSON.stringify({
        startW: els.startW.value,
        targetW: els.targetW.value,
        tdee: els.tdee.value
    }));
}

// 4. API å‘¼å«
async function callApi(payload) {
    els.loading.style.display = "flex";
    try {
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        });
        return await res.json();
    } catch (e) {
        console.error(e);
        alert("é€£ç·šéŒ¯èª¤");
    } finally {
        els.loading.style.display = "none";
    }
}

// 5. è¼‰å…¥ç´€éŒ„èˆ‡è¨ˆç®—ç´¯ç©å„²è“„
async function loadRecords() {
    // A. è¼‰å…¥åˆ—è¡¨
    const data = await callApi({ action: "getRecords" });
    
    let todayTotal = 0;
    const todayStr = new Date().toISOString().split('T')[0].replace(/-/g, '/');
    
    els.recordList.innerHTML = "";
    if (Array.isArray(data)) {
        data.forEach(item => {
            // è¨ˆç®—ä»Šæ—¥ç†±é‡
            if (item.date.includes(todayStr)) {
                todayTotal += Number(item.calories);
            }
            
            // æ¸²æŸ“åˆ—è¡¨
            els.recordList.innerHTML += `
                <div class="record-item">
                    <span>${item.item} <small style="color:#ccc">(${item.calories})</small></span>
                    <button class="delete-btn" onclick="deleteRecord('${item.id}')">Ã—</button>
                </div>`;
        });
    }
    
    els.todayEaten.value = todayTotal;
    updateDailyAndSave(false); // æ›´æ–°ä»Šæ—¥èµ¤å­—é¡¯ç¤º

    // B. è«‹å¾Œç«¯è¨ˆç®—ã€Œæ­·å²ç¸½èµ¤å­—ã€
    // å‚³é€ TDEE çµ¦å¾Œç«¯ï¼Œè®“å®ƒå»ç®—æ¯å¤©çœå¤šå°‘
    const stats = await callApi({ 
        action: "calcSavings", 
        tdee: els.tdee.value 
    });
    
    if (stats && stats.totalSaved !== undefined) {
        updateLongTermProgress(stats.totalSaved);
    }
}

function updateDailyAndSave(shouldReload = true) {
    const tdee = parseInt(els.tdee.value) || 1600;
    const eaten = parseInt(els.todayEaten.value) || 0;
    const deficit = tdee - eaten;
    
    els.todayDeficit.textContent = deficit;
    els.todayDeficit.style.color = deficit >= 0 ? "#C9B29C" : "#c0392b";
    
    if(shouldReload) saveSettings();
}

function updateLongTermProgress(savedAmount) {
    // å–å¾—ç¸½ç›®æ¨™
    const totalGoal = parseInt(els.totalGoalCal.textContent.replace(/,/g, '')) || 1;
    
    // æ›´æ–°æ•¸å­—
    els.savedCal.textContent = savedAmount.toLocaleString();
    
    // è¨ˆç®—ç™¾åˆ†æ¯”
    let percent = (savedAmount / totalGoal) * 100;
    percent = Math.min(100, Math.max(0, percent)); // 0~100
    
    els.longTermProgress.style.width = percent + "%";
    els.longTermPercent.textContent = percent.toFixed(1) + "% å®Œæˆ";
}

// å…¶é¤˜åŠŸèƒ½ï¼šæ–°å¢ã€æœå°‹ã€åˆªé™¤
async function addRecord() {
    const name = els.foodName.value;
    const cal = els.foodCal.value;
    if(!name || !cal) return alert("è«‹è¼¸å…¥å®Œæ•´");
    
    await callApi({ action: "addRecord", item: name, calories: cal });
    els.foodName.value = ""; els.foodCal.value = "";
    loadRecords();
}

async function autoSearch() {
    const name = els.foodName.value;
    if(!name) return;
    if(els.foodCal.value) return; 
    
    const res = await callApi({ action: "searchFood", item: name });
    if(res.calories) {
        els.foodCal.value = res.calories;
        els.foodCal.style.background = "#fff";
        setTimeout(()=>els.foodCal.style.background="", 300);
    }
}

async function deleteRecord(id) {
    if(!confirm("åˆªé™¤æ­¤ç­†?")) return;
    await callApi({ action: "deleteRecord", id: id });
    loadRecords();
}

function googleSearch() {
    const val = els.foodName.value;
    if(val) window.open(`https://www.google.com/search?q=${val}+ç†±é‡`);
}

window.onload = init;
</script>

</body>
</html>