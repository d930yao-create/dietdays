<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BowBow Calorie Savings</title>
<link rel="icon" href="logo.png" type="image/png">
<link rel="apple-touch-icon" href="logo.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="BowBow Diary">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#FDFBF7">
 
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg-color: #FDFBF7;
  --card-bg: #FFFFFF;
  --text-main: #6D5D50;
  --text-light: #9C8C74;
  --accent: #DBC8B6;
  --accent-hover: #C9B29C;
  --gold: #D4AF37;
  --input-bg: #F7F3EF;
  --border-radius: 16px;
}

body {
  margin: 0;
  font-family: 'Noto Sans TC', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-main);
  padding: 20px;
  min-height: 100vh;
  box-sizing: border-box;
}

h2 {
  font-family: 'DM Serif Display', serif;
  color: var(--text-main);
  margin-top: 0;
  margin-bottom: 20px;
  font-size: 22px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1.2fr 1fr 0.8fr;
  gap: 24px;
}

@media (max-width: 900px) {
  .container { grid-template-columns: 1fr; }
}

.card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 24px;
  box-shadow: 0 4px 20px rgba(109, 93, 80, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.6);
  display: flex;
  flex-direction: column;
}

label {
  font-size: 11px;
  color: var(--text-light);
  letter-spacing: 1px;
  margin-bottom: 4px;
  display: block;
  text-transform: uppercase;
  font-weight: 600;
}

input {
  width: 100%;
  padding: 10px 14px;
  margin-bottom: 12px;
  border-radius: 12px;
  border: none;
  background: var(--input-bg);
  color: var(--text-main);
  font-size: 14px;
  box-sizing: border-box;
}

input:disabled {
    background: transparent;
    border: 1px dashed #E0D6CC;
    color: var(--text-light);
}

button {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: var(--accent);
  color: #fff;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.3s;
  font-weight: 500;
}
button:hover { background: var(--accent-hover); }

/* --- å„²è“„ç½å°ˆå€æ¨£å¼ --- */
.savings-box {
    background: #FDF9F3;
    border: 1px solid #EFE4D6;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
}

.goal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 10px;
}
.goal-title { font-size: 14px; font-weight: bold; color: var(--text-main); }
.goal-nums { font-size: 12px; color: var(--text-light); }
.goal-nums span { color: var(--accent-hover); font-weight: bold; font-size: 16px; }

.big-progress-bg {
    background: #EBE5DE;
    height: 14px;
    border-radius: 99px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
.big-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #DBC8B6, #D4AF37);
    width: 0%;
    transition: width 1s ease-out;
}
.progress-badge {
    text-align: right;
    font-size: 11px;
    margin-top: 5px;
    color: var(--text-light);
}

/* æ¯æ—¥è¨ˆç®—å€ */
.daily-calc {
    border-top: 1px dashed #E0D6CC;
    padding-top: 15px;
}

/* é«”é‡è¼¸å…¥æ¡†ä¸‰æ¬„æ’ç‰ˆ */
.weight-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
}

@media (max-width: 600px) {
  .weight-inputs {
     grid-template-columns: 1fr;
  }
}

.row-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.cal-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 14px;
}
.cal-row.total {
    font-weight: bold;
    color: var(--text-main);
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
}

/* ç´€éŒ„åˆ—è¡¨ */
.record-list {
    flex: 1;
    overflow-y: auto;
    max-height: 400px;
    padding-right: 5px;
}
.record-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px dashed #EBE5DE;
    font-size: 13px;
}
.delete-btn { width: auto; background: none; color: #ccc; padding: 0 5px; cursor: pointer; }

/* Loading */
#loading {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(255,255,255,0.8);
    display: none; justify-content: center; align-items: center; z-index: 99;
    color: var(--accent);
}
</style>
</head>
<body>

<div id="loading">Syncing...</div>

<div class="container">
    
<div class="card">
    <h2>Savings Bank</h2>
    
<div class="weight-inputs">
        <div>
            <label>åˆå§‹ (Start)</label>
            <input type="number" id="startWeight" value="77" disabled>

        </div>

        <div style="display:flex; flex-direction:column;">
            <label style="color:var(--accent-hover);">ä»Šæ—¥ (Current)</label>
            
            <div style="display:flex; gap:8px;"> 
                <input type="number" id="currentWeight" placeholder="è¼¸å…¥" style="margin-bottom:0;">
                <button onclick="logWeight(this)">ğŸ’¾</button>

            </div>

            <div id="weightDiffDisplay" style="font-size:13px; color:var(--text-main); margin-top:6px; font-weight:bold;">
                è·é›¢ç›®æ¨™: <span id="diffVal" style="color:#D4AF37;">--</span> kg
            </div>

            <div id="lastWeightLog" style="font-size:10px; color:#aaa; margin-top:4px; text-align:right;">
                å°šæœªç´€éŒ„
            </div>
        </div>

        <div>
            <label>ç›®æ¨™ (Goal)</label>
            <input type="number" id="targetWeight" value="55" style="font-weight:bold; color:var(--text-main);" onchange="calcTotalGoal(); saveSettings();">
        </div>
    </div>

    <div class="savings-box">
            <div class="goal-header">
                <div class="goal-title">ğŸ”¥ ç‡ƒç‡’é€²åº¦</div>
                <div class="goal-nums">
                    å·²å­˜ <span id="savedCal">0</span> / <span id="totalGoalCal">0</span> kcal
                </div>
            </div>
            <div class="big-progress-bg">
                <div class="big-progress-fill" id="longTermProgress"></div>
            </div>
            <div class="progress-badge" id="longTermPercent">0% å®Œæˆ</div>
            <p style="font-size:11px; color:var(--text-light); margin-top:8px; line-height:1.4;">
                *é‚è¼¯ï¼šæ¸›å»1å…¬æ–¤éœ€æ¶ˆè€— 7700 kcalã€‚<br>
                é€²åº¦æ¢æœƒæ ¹æ“šä½ æ¯å¤© (TDEE - æ”å–) çš„èµ¤å­—ç´¯ç©ã€‚
            </p>
        </div>

        <div class="daily-calc">
            <div class="row-split">
                <div>
                    <label>æ¯æ—¥ TDEE (ä»£è¬)</label>
                    <input type="number" id="tdee" value="1350" placeholder="åŸºç¤ä»£è¬" onchange="updateDailyAndSave()">
                </div>
                <div>
                    <label>ä»Šæ—¥å·²åƒ</label>
                    <input type="number" id="todayEaten" value="0" disabled>
                </div>
            </div>
            <div class="cal-row total">
                <span>ä»Šæ—¥å­˜æ¬¾ (Deficit)</span>
                <span id="todayDeficit">0</span>
            </div>
            <div style="font-size:11px; color:#aaa; margin-top:4px;">æ­£æ•¸ä»£è¡¨ä»Šæ—¥è®Šç˜¦ï¼Œè² æ•¸ä»£è¡¨è®Šèƒ–</div>
        </div>
    </div>

    <div class="card">
        <h2>Add Food</h2>
        <label>Food Name</label>
<input type="text" id="foodName" oninput="autoSearch()">

        
        <label>Calories</label>
        <input type="number" id="foodCal" placeholder="kcal">
        
        <button onclick="addRecord()">ï¼‹ Add Record</button>
        <button onclick="googleSearch()" style="background:transparent; color:#999; border:1px solid #eee; margin-top:10px;">ğŸ” Google Check</button>
    </div>

<div class="card">
        <h2>History</h2>
        <div class="record-list" id="recordList">Loading...</div>
        
<div id="historyToggleBtn" onclick="toggleHistory()" style="
            text-align: center;
            font-size: 12px;
            color: var(--text-light);
            padding: 10px 0;
            cursor: pointer;
            margin-top: 5px; /* ç¨å¾®ç¸®å°é–“è· */
            display: none;
        ">
            â¬‡ï¸ æŸ¥çœ‹è¿‘æœŸç´€éŒ„ (Recent)
        </div>

        <div class="record-list" id="oldRecordList" style="
            display: none; 
            opacity: 0.7; 
            max-height: 200px; /* é™åˆ¶é«˜åº¦è®“å®ƒå¯æ»‘å‹• */
        "></div>
    </div>


<script>
// ğŸ”¥ è«‹å°‡ä½ çš„ Web App URL è²¼åœ¨é€™è£¡
const API_URL = "https://script.google.com/macros/s/AKfycbzs4l4E4kxTxxBicnuHSgKo7zb1gMyC-hBnHKBoFW9Hpol1kOuQM8cc32C34fjXepiy/exec";

// UI Elements
const els = {
    startW: document.getElementById('startWeight'),
    currentW: document.getElementById('currentWeight'), 
    targetW: document.getElementById('targetWeight'),
    tdee: document.getElementById('tdee'),
    savedCal: document.getElementById('savedCal'),
    totalGoalCal: document.getElementById('totalGoalCal'),
    longTermProgress: document.getElementById('longTermProgress'),
    longTermPercent: document.getElementById('longTermPercent'),
    todayEaten: document.getElementById('todayEaten'),
    todayDeficit: document.getElementById('todayDeficit'),
    foodName: document.getElementById('foodName'),
    foodCal: document.getElementById('foodCal'),
    recordList: document.getElementById('recordList'),
    loading: document.getElementById('loading')
};

// 1. åˆå§‹åŒ–
async function init() {
    // A. è®€å–æœ¬åœ°å¿«å–
    const saved = JSON.parse(localStorage.getItem('bowbow_settings'));
    if (saved) {
        if(saved.startW) els.startW.value = saved.startW;
        if(saved.currentW) els.currentW.value = saved.currentW;
        if(saved.targetW) els.targetW.value = saved.targetW;
        if(saved.tdee) els.tdee.value = saved.tdee;
        calcTotalGoal(); 
        updateDiff(); 
    }

    // ğŸ”¥ é—œéµï¼šå…ˆå¼·åˆ¶é—œé–‰ Loading
    els.loading.style.display = "none";

    // B. èƒŒæ™¯å»é›²ç«¯æŠ“æœ€æ–°çš„è¨­å®š
    callApi({ action: "getSettings" }, false).then(cloudSettings => {
        if (cloudSettings && cloudSettings.start) {
            els.startW.value = cloudSettings.start;
            els.currentW.value = cloudSettings.current;
            els.targetW.value = cloudSettings.target;
            els.tdee.value = cloudSettings.tdee;
            
            localStorage.setItem('bowbow_settings', JSON.stringify({
                startW: cloudSettings.start,
                currentW: cloudSettings.current,
                targetW: cloudSettings.target,
                tdee: cloudSettings.tdee
            }));
            
            calcTotalGoal(); 
            updateDiff(); 
            console.log("è¨­å®šåŒæ­¥å®Œæˆ â˜ï¸");
        }
    });

    // C. èƒŒæ™¯è¼‰å…¥æ­·å²ç´€éŒ„
    loadRecords(false); 
}

// 2. è¨ˆç®—ç¸½ç›®æ¨™ & å³æ™‚æ›´æ–°é€²åº¦æ¢
function calcTotalGoal() {
    const start = parseFloat(els.startW.value) || 77;
    const current = parseFloat(els.currentW.value) || start; 
    const target = parseFloat(els.targetW.value) || 55;
    
    let totalDiff = start - target;
    if (totalDiff <= 0) totalDiff = 1;

    let lostDiff = start - current;
    if (lostDiff < 0) lostDiff = 0; 

    const totalCalNeeded = Math.round(totalDiff * 7700);
    const currentSavedCal = Math.round(lostDiff * 7700); 

    els.totalGoalCal.textContent = totalCalNeeded.toLocaleString();
    els.savedCal.textContent = currentSavedCal.toLocaleString();

    let percent = (lostDiff / totalDiff) * 100;
    percent = Math.min(100, Math.max(0, percent)); 

    els.longTermProgress.style.width = percent + "%";
    els.longTermPercent.textContent = percent.toFixed(1) + "% å®Œæˆ";

    return totalCalNeeded;
}

// 3. è¨ˆç®—ä¸¦é¡¯ç¤ºã€Œé‚„å·®å¹¾å…¬æ–¤ã€
function updateDiff() {
    const current = parseFloat(els.currentW.value);
    const target = parseFloat(els.targetW.value);
    const diffEl = document.getElementById("diffVal");
    const labelEl = document.getElementById("weightDiffDisplay");

    if (current && target && diffEl && labelEl) {
        let diff = (current - target).toFixed(1); 
        
        if (diff > 0) {
            diffEl.innerText = diff;
            labelEl.innerHTML = `è·é›¢ç›®æ¨™: <span style="color:#c0392b; font-size:15px;">${diff}</span> kg`;
        } else {
            labelEl.innerHTML = "ğŸ‰ å·²é”æˆç›®æ¨™ï¼";
            labelEl.style.color = "#D4AF37";
        }
    }
}

// 4. å„²å­˜è¨­å®š
function saveSettings() {
    const data = {
        start: els.startW.value,
        current: els.currentW.value,
        target: els.targetW.value,
        tdee: els.tdee.value
    };

    localStorage.setItem('bowbow_settings', JSON.stringify({
        startW: data.start,
        currentW: data.current,
        targetW: data.target,
        tdee: data.tdee
    }));

    callApi({ 
        action: "saveSettings", 
        start: data.start, 
        current: data.current, 
        target: data.target, 
        tdee: data.tdee 
    }, false);
}

// 5. API å‘¼å«
async function callApi(payload, showLoading = true) {
    if (showLoading) els.loading.style.display = "flex";
    
    try {
        const controller = new AbortController();
        setTimeout(() => controller.abort(), 8000);

        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(payload),
            signal: controller.signal
        });

        if (!res.ok) throw new Error("API Error");
        return await res.json();
    } catch (e) {
        console.error(e);
        if (showLoading) alert("é€£ç·šéŒ¯èª¤"); 
    } finally {
        if (showLoading) els.loading.style.display = "none";
    }
}

// 6. è¼‰å…¥ç´€éŒ„
async function loadRecords(showLoading = true) {
    const data = await callApi({ action: "getRecords" }, showLoading);
    
    let todayTotal = 0;
    
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}/${mm}/${dd}`; 

    const todayListEl = document.getElementById("recordList"); 
    const oldListEl = document.getElementById("oldRecordList"); 
    const toggleBtn = document.getElementById("historyToggleBtn"); 
    
    todayListEl.innerHTML = "";
    if(oldListEl) oldListEl.innerHTML = ""; 
    
    let hasOldData = false;

    if (Array.isArray(data)) {
        if (data.length === 0) {
             todayListEl.innerHTML = "<div style='text-align:center; color:#ccc; padding:20px;'>å°šç„¡ç´€éŒ„</div>";
        }

        data.forEach(item => {
            const isToday = item.date.startsWith(todayStr);
            
            let displayTime = "";
            if (isToday) {
                displayTime = item.date.substring(11, 16);
            } else {
                const parts = item.date.split(' ')[0].split('/'); 
                if(parts.length >= 3) displayTime = parts[1] + '/' + parts[2];
                else displayTime = item.date;
            }

            if (isToday) {
                todayTotal += Number(item.calories);
            } else {
                hasOldData = true;
            }

            const html = `
                <div class="record-item ${isToday ? 'today-highlight' : ''}">
                    <div>
                        <div style="font-weight:500;">${item.item}</div>
                        <div style="font-size:11px; color:#ccc;">${displayTime}</div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span style="color:var(--accent-hover); font-weight:500; margin-right:5px;">${item.calories}</span>
                        <button class="delete-btn" onclick="deleteRecord('${item.id}')">Ã—</button>
                    </div>
                </div>`;

            if (isToday) {
                todayListEl.innerHTML += html;
            } else {
                if(oldListEl) oldListEl.innerHTML += html;
            }
        });
    }
    
    if (toggleBtn) {
        if (hasOldData) {
            toggleBtn.style.display = "block";
            if(oldListEl.style.display === 'block') {
                 toggleBtn.innerText = "â¬†ï¸ æ”¶èµ·ç´€éŒ„";
            } else {
                 toggleBtn.innerText = "â¬‡ï¸ æŸ¥çœ‹è¿‘æœŸç´€éŒ„";
            }
        } else {
            toggleBtn.style.display = "none";
        }
    }

    els.todayEaten.value = todayTotal;
    updateDailyAndSave(false); 

    const stats = await callApi({ action: "calcSavings", tdee: els.tdee.value }, false); 
    if (stats && stats.totalSaved !== undefined) {
        updateLongTermProgress(stats.totalSaved);
    }
} // ğŸ”¥ æˆ‘æŠŠé€™è£¡ç¼ºå°‘çš„æ‹¬è™Ÿè£œä¸Šäº†ï¼

// 7. æ›´æ–°æ¯æ—¥èµ¤å­—é¡¯ç¤º
function updateDailyAndSave(shouldReload = true) {
    const tdee = parseInt(els.tdee.value) || 1350;
    const eaten = parseInt(els.todayEaten.value) || 0;
    const deficit = tdee - eaten;
    
    els.todayDeficit.textContent = deficit;
    els.todayDeficit.style.color = deficit >= 0 ? "#C9B29C" : "#c0392b";
    
    if(shouldReload) saveSettings();
}

// 8. æ›´æ–°é•·æœŸé€²åº¦æ¢
function updateLongTermProgress(backendSaved) {
    if (els.currentW.value) {
        calcTotalGoal(); 
    } else {
        const totalGoal = parseInt(els.totalGoalCal.textContent.replace(/,/g, '')) || 1;
        els.savedCal.textContent = backendSaved.toLocaleString();
        let percent = (backendSaved / totalGoal) * 100;
        els.longTermProgress.style.width = percent + "%";
        els.longTermPercent.textContent = percent.toFixed(1) + "% å®Œæˆ";
    }
}

// 9. è¨˜éŒ„é«”é‡æŒ‰éˆ•åŠŸèƒ½
async function logWeight(btn) {
    const w = els.currentW.value;
    if (!w) return alert("è«‹è¼¸å…¥é«”é‡ï¼");

    const originalText = btn.innerText;
    btn.innerText = "â³";
    btn.disabled = true;

    try {
        await callApi({ action: "logWeight", weight: w }, false);

        updateDiff(); 
        calcTotalGoal(); 
        
        const now = new Date();
        const timeStr = (now.getMonth()+1)+'/'+now.getDate()+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
        document.getElementById("lastWeightLog").innerText = "å·²å­˜: " + timeStr;
        document.getElementById("lastWeightLog").style.color = "#D4AF37";

        saveSettings(); 

    } catch (e) {
        alert("å„²å­˜å¤±æ•—");
    } finally {
        btn.innerText = "âœ…";
        setTimeout(() => { 
            btn.innerText = originalText; 
            btn.disabled = false; 
        }, 2000);
    }
}

// 10. å…¶ä»–åŠŸèƒ½
async function addRecord() {
    const name = els.foodName.value;
    const cal = els.foodCal.value;
    if(!name || !cal) return alert("è«‹è¼¸å…¥å®Œæ•´");
    
    // æŠ“å–æ‰‹æ©Ÿç•¶ä¸‹æ™‚é–“
    const now = new Date();
    // æ ¼å¼åŒ–ç‚ºï¼š2025/12/13 14:30
    const dateStr = now.getFullYear() + '/' + 
                   (now.getMonth()+1).toString().padStart(2, '0') + '/' + 
                   now.getDate().toString().padStart(2, '0') + ' ' + 
                   now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');

    await callApi({ action: "addRecord", item: name, calories: cal, date: dateStr });
    
    els.foodName.value = ""; els.foodCal.value = "";
    await loadRecords(false);
}

//  autoSearch
async function autoSearch() {
    const nameInput = els.foodName;
    const calInput = els.foodCal;
    const name = nameInput.value.trim(); 

    if (!name) return;
    if (calInput.value && calInput.value != "") return;

    const originalPlaceholder = calInput.placeholder;
    calInput.placeholder = "ğŸ”...";
    
    try {
        const res = await callApi({ action: "searchFood", item: name }, false);

        if (res && res.calories) {
            calInput.value = res.calories;
            calInput.style.backgroundColor = "#fff9db"; 
            setTimeout(() => { calInput.style.backgroundColor = ""; }, 1000);
        }
    } catch (e) {
        console.error("æœå°‹å¤±æ•—", e);
    } finally {
        calInput.placeholder = originalPlaceholder;
    }
}

async function deleteRecord(id) {
    if(!confirm("åˆªé™¤æ­¤ç­†?")) return;
    await callApi({ action: "deleteRecord", id: id });
    loadRecords();
}

function googleSearch() {
    const val = els.foodName.value;
    if(val) window.open(`https://www.google.com/search?q=${val}+ç†±é‡`);
}

function toggleHistory() {
    const oldList = document.getElementById("oldRecordList");
    const btn = document.getElementById("historyToggleBtn");
    
    if (!oldList || !btn) return;

    if (oldList.style.display === "none") {
        oldList.style.display = "block";
        btn.innerText = "â¬†ï¸ æ”¶èµ·ç´€éŒ„";
        oldList.scrollTop = oldList.scrollHeight;
    } else {
        oldList.style.display = "none";
        btn.innerText = "â¬‡ï¸ æŸ¥çœ‹è¿‘æœŸç´€éŒ„ (Recent)";
    }
}

window.onload = init;
</script>

</body>
</html>