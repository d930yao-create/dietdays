<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯ç†±é‡è¨˜å¸³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDF8F6; }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.6);
        }
        .progress-bar { transition: width 0.5s ease-in-out; }
        
        /* è¼‰å…¥ä¸­å‹•ç•« */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #fb7185; /* Rose-400 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* é®ç½©å±¤ */
        #loadingOverlay {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="text-gray-600">

    <div id="loadingOverlay" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-5 rounded-2xl shadow-xl flex flex-col items-center">
            <div class="spinner mb-3"></div>
            <p class="text-xs text-rose-400 font-bold tracking-widest">SYNCING...</p>
        </div>
    </div>

    <div class="max-w-md mx-auto min-h-screen relative pb-20">
        
<div class="px-6 pt-6 mb-6">
            <div class="glass-card p-6 bg-white/90">
                
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-xl font-bold text-gray-800 tracking-wide flex items-center">
                        <span class="bg-rose-100 text-rose-400 w-8 h-8 flex items-center justify-center rounded-full mr-2 text-sm">
                            <i class="fa-solid fa-utensils"></i>
                        </span>
                        ç†±é‡è¨˜å¸³æœ¬
                    </h1>
                    <div class="flex gap-2">
                        <span class="text-xs font-mono text-gray-400 bg-gray-100 px-3 py-1 rounded-full flex items-center" id="currentDate"></span>
                        <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition flex items-center justify-center">
                            <i class="fa-solid fa-gear"></i>
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-center px-2 mb-3 text-xs text-gray-500">
                    <div>ç›®å‰: <span id="displayCurrentWeight" class="font-bold text-gray-700">--</span> kg</div>
                    <div class="flex items-center gap-1">
                        ç›®æ¨™: <span id="displayTargetWeight" class="font-bold text-gray-700">--</span> kg
                        <i id="weightTrendIcon" class="fa-solid fa-arrow-right text-gray-300"></i>
                    </div>
                </div>

                <div class="p-4 bg-gradient-to-br from-rose-50 to-orange-50 rounded-2xl border border-rose-100/50">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-500">ä»Šæ—¥ç›®æ¨™ (TDEE)</span>
                        <span class="font-bold text-gray-700 font-mono" id="budgetDisplay">1800</span>
                    </div>
                    <div class="flex justify-between items-end mb-3">
                        <div>
                            <span class="text-xs text-gray-400">å·²åƒ</span>
                            <div class="text-2xl font-bold text-rose-500 font-mono" id="totalIntake">0</div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-400">å‰©é¤˜</span>
                            <div class="text-xl font-bold text-emerald-500 font-mono" id="balance">1800</div>
                        </div>
                    </div>
                    <div class="w-full bg-white rounded-full h-2 overflow-hidden shadow-sm">
                        <div id="progressBar" class="progress-bar bg-rose-400 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-center mt-2 text-gray-400" id="statusText">ä»Šå¤©é‚„å¯ä»¥åƒå¾—å¾ˆé–‹å¿ƒï¼</p>
                </div>
            </div>
        </div>

<div class="px-6 mt-6 border-t border-rose-100/50 pt-4 pb-20">
            <h3 class="text-sm font-bold text-gray-400 mb-2 px-2 flex items-center gap-2">
                <i class="fa-solid fa-robot text-violet-400"></i>
                å•å• AI ç‡Ÿé¤Šå¸«
            </h3>
            
            <div class="glass-card p-4">
                <div id="aiResponseBox" class="hidden mb-3 bg-rose-50/50 p-3 rounded-xl border border-rose-100 text-sm text-gray-700 leading-relaxed relative">
                    <div class="absolute -bottom-2 left-6 w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[8px] border-t-rose-100"></div>
                    <span id="aiContent"></span>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="aiQuestionInput" placeholder="ä¾‹å¦‚ï¼šåŠå€‹æ’éª¨ä¾¿ç•¶ç†±é‡å¤šå°‘ï¼Ÿ" 
                        class="w-full p-3 bg-gray-100 rounded-xl text-sm outline-none focus:bg-white focus:ring-2 focus:ring-violet-200 transition text-gray-700">
                    
                    <button onclick="askAiQuestion()" class="w-12 h-12 rounded-xl bg-gradient-to-tr from-violet-500 to-fuchsia-500 text-white flex items-center justify-center shadow-md hover:shadow-lg active:scale-95 transition">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 text-center">
                    <i class="fa-solid fa-circle-info mr-1"></i>
                    æƒ³å•ä»€éº¼éƒ½èƒ½å•ï¼Œä¸ç”¨å®¢æ°£ï¼
                </p>
            </div>
        </div>

<div class="px-6 mb-6">
            <h2 class="text-sm font-bold text-gray-400 mb-3 px-2 flex justify-between items-center">
                <span>æ–°å¢ä¸€ç­†æ”¯å‡º</span>
                <i class="fa-solid fa-pen-nib text-xs"></i>
            </h2>
            <div class="glass-card p-5 space-y-4 relative overflow-hidden">
                <div id="aiCalculatingOverlay" class="absolute inset-0 bg-white/90 z-20 hidden flex flex-col items-center justify-center">
                    <i class="fa-solid fa-calculator fa-bounce text-3xl text-rose-400 mb-2"></i>
                    <p class="text-xs font-bold text-gray-500">AI æ­£åœ¨å¹«ä½ è¨ˆç®—ç†±é‡...</p>
                </div>

                <div class="relative">
                    <label class="text-xs text-gray-400 pl-1 mb-1 block">åƒäº†ä»€éº¼ï¼Ÿ</label>
                    <div class="flex gap-2">
                        <input type="text" id="foodInput" placeholder="ä¾‹å¦‚ï¼šæ»·é›è…¿ä¾¿ç•¶å»çš®" 
                            class="w-full p-3 bg-gray-50/80 rounded-xl outline-none focus:ring-2 focus:ring-rose-200 text-gray-700 transition border border-transparent focus:border-rose-300"
                            oninput="searchFood(this.value)">
                        
                        <button onclick="askAiToEstimate()" class="whitespace-nowrap px-4 py-2 bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white rounded-xl shadow-md hover:shadow-lg active:scale-95 transition text-xs font-bold flex items-center gap-1">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            AIå¹«æˆ‘ç®—
                        </button>
                    </div>
                    
                    <div id="suggestions" class="hidden absolute w-full bg-white shadow-xl rounded-xl mt-1 z-20 max-h-40 overflow-y-auto border border-gray-100"></div>
                </div>

                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="text-xs text-gray-400 pl-1 mb-1 block">ç†±é‡ (Kcal)</label>
                        <input type="number" id="calInput" placeholder="0" class="w-full p-3 bg-gray-50/80 rounded-xl outline-none focus:ring-2 focus:ring-rose-200 text-gray-700 font-mono text-center font-bold">
                    </div>
                    <div class="w-1/2 flex items-end">
                        <button onclick="addRecord()" class="w-full p-3 bg-gray-800 text-white rounded-xl shadow-lg hover:bg-gray-700 transition active:scale-95 hover:shadow-xl">
                            <i class="fa-solid fa-plus mr-1"></i> åŠ å…¥
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="px-6">
            <h2 class="text-sm font-bold text-gray-400 mb-3 px-2 flex justify-between">
                <span>ä»Šæ—¥æ˜ç´°</span>
                <button onclick="fetchData()" class="text-xs text-rose-400 hover:text-rose-600"><i class="fa-solid fa-rotate-right"></i> é‡æ–°æ•´ç†</button>
            </h2>
            <div id="recordList" class="space-y-3 pb-24">
                </div>
        </div>

    </div>

    <script>
        // ==========================================
        //  è¨­å®šå€ï¼šè«‹å¡«å…¥ä½ çš„ Google Apps Script ç¶²å€
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzs4l4E4kxTxxBicnuHSgKo7zb1gMyC-hBnHKBoFW9Hpol1kOuQM8cc32C34fjXepiy/exec"; 
        // ä¾‹å¦‚: https://script.google.com/macros/s/AKfycbx.../exec

        // 1. åˆå§‹åŒ–è¨­å®š
        const defaultBudget = 1800; 
        let records = []; 

// ==========================================
    //  å€‹äººè¨­å®šåŠŸèƒ½ (æ–°å¢)
    // ==========================================
    
    // é è¨­å€¼è®Šæ•¸ (æ”¹ç‚º letï¼Œå› ç‚ºæœƒè¢«ä¿®æ”¹)
    let userSettings = JSON.parse(localStorage.getItem('myBodySettings')) || {
        budget: 1800,
        currentWeight: 60,
        targetWeight: 55
    };

    // å•Ÿå‹•æ™‚æ›´æ–°ç•«é¢ä¸Šçš„è¨­å®šå€¼
    function updateSettingsUI() {
        // æ›´æ–°å…¨åŸŸè®Šæ•¸ (é‡è¦ï¼šé€™è£¡æœƒè¦†è“‹åŸæœ¬çš„ defaultBudget)
        // æ³¨æ„ï¼šåŸæœ¬ç¨‹å¼ç¢¼çš„ defaultBudget å¦‚æœæ˜¯ constï¼Œè«‹æ”¹æˆ letï¼Œæˆ–è€…ç›´æ¥ç”¨ userSettings.budget
        document.getElementById('budgetDisplay').innerText = userSettings.budget;
        document.getElementById('displayCurrentWeight').innerText = userSettings.currentWeight;
        document.getElementById('displayTargetWeight').innerText = userSettings.targetWeight;
        
        // æ›´æ–°é«”é‡è¶¨å‹¢ç®­é ­
        const trendIcon = document.getElementById('weightTrendIcon');
        if (userSettings.currentWeight > userSettings.targetWeight) {
            trendIcon.className = "fa-solid fa-arrow-trend-down text-emerald-400"; // æ¸›é‡ä¸­
        } else if (userSettings.currentWeight < userSettings.targetWeight) {
            trendIcon.className = "fa-solid fa-arrow-trend-up text-rose-400"; // å¢é‡ä¸­
        } else {
            trendIcon.className = "fa-solid fa-check text-blue-400"; // é”æˆ
        }

        // é‡æ–°æ¸²æŸ“å„€è¡¨æ¿ (ç¢ºä¿é¤˜é¡è¨ˆç®—æ­£ç¢º)
        render(); 
    }

    // æ‰“é–‹è¨­å®šè¦–çª—
    function openSettings() {
        document.getElementById('settingBudget').value = userSettings.budget;
        document.getElementById('settingCurrentWeight').value = userSettings.currentWeight;
        document.getElementById('settingTargetWeight').value = userSettings.targetWeight;
        
        const modal = document.getElementById('settingsModal');
        modal.classList.remove('hidden');
    }

    // é—œé–‰è¨­å®šè¦–çª—
    function closeSettings() {
        document.getElementById('settingsModal').classList.add('hidden');
    }

    // å„²å­˜è¨­å®š
    function saveSettings() {
        const newBudget = parseInt(document.getElementById('settingBudget').value);
        const newCurrent = parseFloat(document.getElementById('settingCurrentWeight').value);
        const newTarget = parseFloat(document.getElementById('settingTargetWeight').value);

        if (isNaN(newBudget) || isNaN(newCurrent) || isNaN(newTarget)) {
            alert("è«‹è¼¸å…¥æ­£ç¢ºçš„æ•¸å­—å–”ï¼");
            return;
        }

        userSettings = {
            budget: newBudget,
            currentWeight: newCurrent,
            targetWeight: newTarget
        };

        // å­˜å…¥ localStorage
        localStorage.setItem('myBodySettings', JSON.stringify(userSettings));
        
        closeSettings();
        updateSettingsUI();
        
        alert("è¨­å®šå·²æ›´æ–°ï¼ä¸€èµ·åŠ æ²¹ï¼ğŸ’ª");
    }

    // ==========================================
    //  è«‹è¨˜å¾—ä¿®æ”¹åŸæœ¬ render() è£¡çš„è®Šæ•¸
    // ==========================================
        
        // é è¨­è³‡æ–™åº« (ç•¶é›²ç«¯é‚„æ²’æŠ“åˆ°æ™‚å¢Šæª”ç”¨)
        const defaultDatabase = [
            { name: "ç™½é£¯ (ä¸€ç¢—)", cal: 280 },
            { name: "æ°´ç…®è›‹", cal: 75 },
            { name: "æ‹¿éµ (ä¸­æ¯)", cal: 120 }
        ];
        let foodDatabase = defaultDatabase;

        // è¨­å®šæ—¥æœŸ
        const todayDateStr = new Date().toLocaleDateString();
        document.getElementById('currentDate').innerText = todayDateStr;

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè®€å–é›²ç«¯è³‡æ–™ ---
        async function fetchData() {
            showLoading(true);
            try {
                // å‘¼å« API å–å¾— getData
                const response = await fetch(`${API_URL}?action=getData`);
                const data = await response.json();

                if (data.status === 'success') {
                    // 1. æ›´æ–°å…¨åŸŸè³‡æ–™åº« (åˆä½µé è¨­èˆ‡é›²ç«¯çš„æ–°é£Ÿç‰©)
                    foodDatabase = [...defaultDatabase, ...data.foodDB];
                    // å»é™¤é‡è¤‡åç¨± (ç°¡å–®æ¿¾é™¤)
                    foodDatabase = foodDatabase.filter((v,i,a)=>a.findIndex(t=>(t.name===v.name))===i);

                    // 2. éæ¿¾å‡ºã€Œä»Šå¤©ã€çš„ç´€éŒ„
                    // æ³¨æ„ï¼šGoogle Sheet å›å‚³çš„ date æ ¼å¼å¯èƒ½æœƒå› èªç³»ä¸åŒï¼Œé€™è£¡åšç°¡å–®å­—ä¸²æ¯”å°
                    records = data.records.filter(r => r.date === todayDateStr);
                    
                    render();
                }
            } catch (error) {
                console.error("è®€å–å¤±æ•—:", error);
                alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€è¨­å®š");
            } finally {
                showLoading(false);
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ–°å¢ç´€éŒ„ (å¯«å…¥é›²ç«¯) ---
        function addRecord() {
            const nameInput = document.getElementById('foodInput');
            const calInput = document.getElementById('calInput');
            const name = nameInput.value.trim();
            const cal = parseInt(calInput.value);

            if (!name || isNaN(cal)) {
                alert("è«‹è¼¸å…¥é£Ÿç‰©åç¨±èˆ‡ç†±é‡å–”ï¼");
                return;
            }

            const id = Date.now(); // ç”¢ç”Ÿå”¯ä¸€ ID
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            // 1. å…ˆåœ¨ç•«é¢å‘ˆç¾ (è®“ä½¿ç”¨è€…æ„Ÿè¦ºå¾ˆå¿«)
            const newRecord = { id, name, cal, time, date: todayDateStr };
            records.unshift(newRecord);
            
            // æ¸…ç©ºè¼¸å…¥
            nameInput.value = '';
            calInput.value = '';
            document.getElementById('suggestions').classList.add('hidden');
            render();

            // 2. èƒŒæ™¯å·å·é€å‡ºè³‡æ–™çµ¦ Google Sheet
            const formData = new FormData();
            formData.append('action', 'addRecord');
            formData.append('id', id);
            formData.append('name', name);
            formData.append('cal', cal);
            formData.append('time', time);

            // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°é£Ÿç‰©ï¼Œé †ä¾¿å­¸ç¿’
            const exists = foodDatabase.some(f => f.name === name);
            if (!exists) {
                foodDatabase.push({ name: name, cal: cal });
                // å‘Šè¨´å¾Œç«¯è¦å­¸ç¿’æ–°é£Ÿç‰©
                const foodData = new FormData();
                foodData.append('action', 'addFood');
                foodData.append('name', name);
                foodData.append('cal', cal);
                fetch(API_URL, { method: 'POST', body: foodData }); // å°„å¾Œä¸ç†
            }

            // æ­£å¼é€å‡ºç´€éŒ„
            fetch(API_URL, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                   console.log("é›²ç«¯å„²å­˜æˆåŠŸ"); 
                })
                .catch(err => {
                    alert("é›²ç«¯åŒæ­¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                });
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šåˆªé™¤ç´€éŒ„ ---
        function deleteRecord(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;

            // 1. ç•«é¢å…ˆåˆª
            records = records.filter(r => r.id != id); // æ³¨æ„ id å‹åˆ¥å¯èƒ½æ˜¯å­—ä¸²æˆ–æ•¸å­—
            render();

            // 2. èƒŒæ™¯é€å‡ºåˆªé™¤è«‹æ±‚
            const formData = new FormData();
            formData.append('action', 'deleteRecord');
            formData.append('id', id);
            
            fetch(API_URL, { method: 'POST', body: formData });
        }

        // æœå°‹é£Ÿç‰©åŠŸèƒ½ (ç¶­æŒä¸è®Š)
        function searchFood(keyword) {
            const suggestionBox = document.getElementById('suggestions');
            if (!keyword) {
                suggestionBox.classList.add('hidden');
                return;
            }
            const matches = foodDatabase.filter(food => food.name.includes(keyword)).slice(0, 10);
            if (matches.length > 0) {
                suggestionBox.innerHTML = matches.map(food => `
                    <div class="p-3 hover:bg-rose-50 cursor-pointer flex justify-between items-center text-sm border-b border-gray-50 last:border-0" 
                        onclick="selectFood('${food.name}', ${food.cal})">
                        <span class="font-medium text-gray-700">${food.name}</span>
                        <span class="text-gray-400 font-mono text-xs bg-gray-100 px-2 py-1 rounded-full">${food.cal} cal</span>
                    </div>`).join('');
                suggestionBox.classList.remove('hidden');
            } else {
                suggestionBox.innerHTML = `
                    <div class="p-3 text-sm text-rose-500 italic">
                        <i class="fa-solid fa-plus-circle mr-1"></i> æ–°é£Ÿç‰©ï¼è¨˜å¸³å¾Œè‡ªå‹•å­¸ç¿’
                    </div>`;
                suggestionBox.classList.remove('hidden');
            }
        }
        function selectFood(name, cal) {
            document.getElementById('foodInput').value = name;
            document.getElementById('calInput').value = cal;
            document.getElementById('suggestions').classList.add('hidden');
        }

        // æ¸²æŸ“ç•«é¢
        function render() {
            const listEl = document.getElementById('recordList');
            const totalEl = document.getElementById('totalIntake');
            const balanceEl = document.getElementById('balance');
            const progressEl = document.getElementById('progressBar');
            const statusEl = document.getElementById('statusText');

            const total = records.reduce((acc, cur) => acc + parseInt(cur.cal), 0);
            const balance = defaultBudget - total;

            totalEl.innerText = total;
            balanceEl.innerText = balance;

            let percentage = (total / defaultBudget) * 100;
            if (percentage > 100) percentage = 100;
            progressEl.style.width = percentage + "%";
            
            if (balance < 0) {
                balanceEl.classList.replace('text-emerald-500', 'text-red-500');
                balanceEl.innerText = `${balance}`;
                progressEl.classList.replace('bg-rose-400', 'bg-red-500');
                statusEl.innerText = "âš ï¸ é ç®—è¶…æ”¯äº†ï¼";
            } else {
                balanceEl.classList.replace('text-red-500', 'text-emerald-500');
                progressEl.classList.replace('bg-red-500', 'bg-rose-400');
                statusEl.innerText = "âœ¨ é›²ç«¯åŒæ­¥ä¸­ï¼Œç‹€æ…‹è‰¯å¥½";
            }

            if (records.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-10 text-gray-300 text-sm">
                        <i class="fa-regular fa-clipboard mb-2 text-2xl"></i>
                        <p>ä»Šå¤©é‚„æ²’é–‹å§‹è¨˜å¸³å–”ï¼</p>
                    </div>`;
            } else {
                listEl.innerHTML = records.map(item => `
                    <div class="glass-card p-4 flex justify-between items-center mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-rose-50 flex items-center justify-center text-rose-400 border border-rose-100">
                                <i class="fa-solid fa-utensils text-sm"></i>
                            </div>
                            <div>
                                <p class="text-gray-800 font-bold text-sm">${item.name}</p>
                                <p class="text-xs text-gray-400">${item.time}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-gray-600 font-mono text-lg">-${item.cal}</span>
                            <button onclick="deleteRecord('${item.id}')" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-300 hover:text-red-400 hover:bg-red-50 transition">
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if(show) overlay.classList.remove('hidden');
            else overlay.classList.add('hidden');
        }
        
        // ç¶²é è¼‰å…¥æ™‚è‡ªå‹•æŠ“è³‡æ–™
        window.onload = fetchData;

// ==========================================
    //  AI å°å¸«è¨­å®šå€
    // ==========================================
    const GEMINI_API_KEY = "AIzaSyAlIroX1gbcR5RUu7rtUA46YrKah7SmNQg"; 
    
// ==========================================
    //  AI åŠŸèƒ½å‡ç´šç‰ˆï¼šè¨ˆç®—èˆ‡å•ç­”
    // ==========================================

    // åŠŸèƒ½ Aï¼šAI è‡ªå‹•ä¼°ç®—ç†±é‡ (åªå›å‚³æ•¸å­—)
    async function askAiToEstimate() {
        const foodName = document.getElementById('foodInput').value;
        const calInput = document.getElementById('calInput');
        const overlay = document.getElementById('aiCalculatingOverlay');

        if (!foodName) {
            alert("è«‹å…ˆè¼¸å…¥é£Ÿç‰©åç¨±ï¼Œä¾‹å¦‚ï¼šæ’éª¨ä¾¿ç•¶");
            return;
        }

        // é¡¯ç¤ºè¨ˆç®—ä¸­ç‰¹æ•ˆ
        overlay.classList.remove('hidden');

        const promptText = `
            ä½¿ç”¨è€…è¼¸å…¥äº†é£Ÿç‰©ï¼š"${foodName}"ã€‚
            è«‹ä¼°ç®—é€™é …é£Ÿç‰©çš„ç†±é‡ï¼ˆå¤§å¡ï¼‰ã€‚
            
            è¦å‰‡ï¼š
            1. åªè¦å›å‚³ä¸€å€‹ã€Œæ•¸å­—ã€å°±å¥½ (ä¾‹å¦‚ï¼š500)ã€‚
            2. ä¸è¦å›å‚³ä»»ä½•æ–‡å­—ã€è§£é‡‹æˆ–å–®ä½ã€‚
            3. å¦‚æœä¸ç¢ºå®šï¼Œè«‹çµ¦å‡ºä¸€å€‹å°ç£å¸¸è¦‹ä»½é‡çš„å¹³å‡ä¼°ç®—å€¼ã€‚
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
            });

            const data = await response.json();
            const aiReply = data.candidates[0].content.parts[0].text.trim();
            
            // å˜—è©¦æŠŠå›å‚³å€¼è½‰æˆæ•¸å­— (éæ¿¾æ‰éæ•¸å­—å­—å…ƒ)
            const estimatedCal = aiReply.replace(/[^0-9]/g, '');
            
            if (estimatedCal) {
                calInput.value = estimatedCal;
                // è¦–è¦ºæç¤ºï¼šé–ƒçˆä¸€ä¸‹å‘ŠçŸ¥å·²å¡«å…¥
                calInput.classList.add('bg-rose-100');
                setTimeout(() => calInput.classList.remove('bg-rose-100'), 500);
            } else {
                alert("AI ç®—ä¸å‡ºä¾†...è«‹æ‰‹å‹•è¼¸å…¥");
            }

        } catch (error) {
            console.error(error);
            alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
        } finally {
            overlay.classList.add('hidden');
        }
    }

    // åŠŸèƒ½ Bï¼šAI ç‡Ÿé¤Šå¸«å•ç­” (æ ¹æ“šæƒ…å¢ƒå›ç­”)
async function askAiQuestion() {
    const questionInput = document.getElementById('aiQuestionInput');
    const aiBox = document.getElementById('aiResponseBox');
    const aiContent = document.getElementById('aiContent');

    const userQuestion = questionInput.value.trim();
    const todayFood = records.map(r => `${r.name}(${r.cal}å¡)`).join('ã€');
    const total = document.getElementById('totalIntake').innerText;
    const budget = userSettings.budget;
    const balance = budget - total;
    const currentWeight = userSettings.currentWeight;
    const targetWeight = userSettings.targetWeight;

    aiBox.classList.remove('hidden');
    aiContent.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-violet-400"></i> AI æ€è€ƒä¸­...';

    let promptText = "";

    // â¤ è‹¥æ²’æ‰“å­— â†’ å›å‚³ä»Šæ—¥å°è©•èª
    if (userQuestion === "") {
        promptText = `
            ä½ æ˜¯ä¸€ä½å°ˆæ¥­åˆå¹½é»˜çš„å€‹äººæ¸›è‚¥æ•™ç·´ã€‚
            ä½¿ç”¨è€…çš„ç›®æ¨™æ˜¯å¾ ${currentWeight}kg æ¸›åˆ° ${targetWeight}kgã€‚
            ä»Šæ—¥é ç®—ï¼š${budget}ï¼Œå·²åƒï¼š${total}ï¼Œå‰©é¤˜ï¼š${balance}ã€‚
            ä»Šæ—¥åƒäº†ï¼š${todayFood || 'ç›®å‰æ²’åƒ'}ã€‚
            è«‹çµ¦äºˆä¸€æ®µ 50 å­—ä»¥å…§çš„çŸ­è©•ï¼Œå¸¶é»å¯æ„›å¹½é»˜ã€‚
        `;
    } 
    
    // â¤ è‹¥æœ‰æå• â†’ ä¾ç…§è¦å‰‡å›ç­”
    else {
        promptText = `
            ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ã€ŒAI ç‡Ÿé¤Šå¸«ã€å…¼ã€Œæ¸›è‚¥é¡§å•ã€ã€‚

            ã€ä½¿ç”¨è€…çš„å•é¡Œã€‘
            "${userQuestion}"

            ã€å›ç­”æº–å‰‡ã€‘
            1. è‹¥ä½¿ç”¨è€…è©¢å•ç†±é‡æˆ–ä»½é‡ â†’ ç›´æ¥ä¼°ç®—æ•¸å­—å³å¯ã€‚
            2. è‹¥ä½¿ç”¨è€…è©¢å•èƒ½ä¸èƒ½åƒ/åƒä»€éº¼æ¯”è¼ƒå¥½ â†’ è«‹åƒè€ƒå‰©é¤˜é ç®—(${balance}å¡)æä¾›å»ºè­°ã€‚
            3. å›ç­”ç²¾ç°¡ã€å¯æ„›ã€100 å­—å…§ç¹é«”ä¸­æ–‡ã€‚
        `;
    }

    try {
        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }]
                })
            }
        );

        const data = await response.json();
        const aiReply = data.candidates[0].content.parts[0].text;

        typeWriter(aiReply, aiContent);
        questionInput.value = "";

    } catch (err) {
        console.error(err);
        aiContent.innerText = "AI æš«æ™‚é›¢ç·šå›‰ï½ç­‰ç­‰å†å•æˆ‘ ğŸ’";
    }
}
    

    // æ‰“å­—æ©Ÿç‰¹æ•ˆ (æ²¿ç”¨ä¹‹å‰çš„)
    function typeWriter(text, element) {
        element.innerHTML = "";
        let i = 0;
        const speed = 20; 
        function type() {
            if (i < text.length) {
                element.innerHTML += text.charAt(i) === '\n' ? '<br>' : text.charAt(i);
                i++;
                setTimeout(type, speed);
            }
        }
        type();
    }

    </script>
<div id="settingsModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeSettings()"></div>
        
        <div class="bg-white w-full max-w-sm mx-4 mb-4 sm:mb-0 rounded-2xl shadow-2xl z-10 p-6 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa-solid fa-sliders text-rose-400 mr-2"></i> å€‹äººè¨­å®š
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æ¯æ—¥ç†±é‡ç›®æ¨™ (TDEE)</label>
                    <input type="number" id="settingBudget" class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-rose-200 font-mono text-lg font-bold text-gray-700">
                    <p class="text-[10px] text-gray-400 mt-1">*é€™æ˜¯ä½ ä¸€å¤©çš„é ç®—ä¸Šé™</p>
                </div>
                
                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ç›®å‰é«”é‡ (kg)</label>
                        <input type="number" id="settingCurrentWeight" class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-rose-200 font-mono font-bold text-gray-700">
                    </div>
                    <div class="w-1/2">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ç›®æ¨™é«”é‡ (kg)</label>
                        <input type="number" id="settingTargetWeight" class="w-full p-3 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-rose-200 font-mono font-bold text-gray-700">
                    </div>
                </div>
            </div>

            <button onclick="saveSettings()" class="w-full mt-6 py-3 bg-gray-800 text-white rounded-xl font-bold shadow-lg hover:bg-gray-700 active:scale-95 transition">
                å„²å­˜è¨­å®š
            </button>
        </div>
</div>

</body>
</html>