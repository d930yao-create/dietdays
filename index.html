<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BowBow Calorie Savings</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg-color: #FDFBF7;
  --card-bg: #FFFFFF;
  --text-main: #6D5D50;
  --text-light: #9C8C74;
  --accent: #DBC8B6;
  --accent-hover: #C9B29C;
  --gold: #D4AF37; /* é”æˆç›®æ¨™çš„é‡‘ */
  --input-bg: #F7F3EF;
  --border-radius: 16px;
}

body {
  margin: 0;
  font-family: 'Noto Sans TC', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-main);
  padding: 20px;
  min-height: 100vh;
  box-sizing: border-box;
}

h2 {
  font-family: 'DM Serif Display', serif;
  color: var(--text-main);
  margin-top: 0;
  margin-bottom: 20px;
  font-size: 22px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1.2fr 1fr 0.8fr; /* ç¬¬ä¸€æ¬„ç¨å¾®å¯¬ä¸€é»çµ¦å„²è“„ç½ */
  gap: 24px;
}

@media (max-width: 900px) {
  .container { grid-template-columns: 1fr; }
}

.card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 24px;
  box-shadow: 0 4px 20px rgba(109, 93, 80, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.6);
  display: flex;
  flex-direction: column;
}

label {
  font-size: 11px;
  color: var(--text-light);
  letter-spacing: 1px;
  margin-bottom: 4px;
  display: block;
  text-transform: uppercase;
  font-weight: 600;
}

input {
  width: 100%;
  padding: 10px 14px;
  margin-bottom: 12px;
  border-radius: 12px;
  border: none;
  background: var(--input-bg);
  color: var(--text-main);
  font-size: 14px;
  box-sizing: border-box;
}

input:disabled {
    background: transparent;
    border: 1px dashed #E0D6CC;
    color: var(--text-light);
}

button {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: var(--accent);
  color: #fff;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.3s;
  font-weight: 500;
}
button:hover { background: var(--accent-hover); }

/* --- å„²è“„ç½å°ˆå€æ¨£å¼ --- */
.savings-box {
    background: #FDF9F3;
    border: 1px solid #EFE4D6;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
}

.goal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 10px;
}
.goal-title { font-size: 14px; font-weight: bold; color: var(--text-main); }
.goal-nums { font-size: 12px; color: var(--text-light); }
.goal-nums span { color: var(--accent-hover); font-weight: bold; font-size: 16px; }

.big-progress-bg {
    background: #EBE5DE;
    height: 14px;
    border-radius: 99px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
.big-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #DBC8B6, #D4AF37); /* æ¼¸å±¤é‡‘ */
    width: 0%;
    transition: width 1s ease-out;
}
.progress-badge {
    text-align: right;
    font-size: 11px;
    margin-top: 5px;
    color: var(--text-light);
}

/* æ¯æ—¥è¨ˆç®—å€ */
.daily-calc {
    border-top: 1px dashed #E0D6CC;
    padding-top: 15px;
}
/* --- æ–°å¢çš„æ¨£å¼ (æ”¾åœ¨ .row-split ä¸Šé¢) --- */

/* å°ˆé–€çµ¦ä¸Šæ–¹ä¸‰å€‹é«”é‡è¼¸å…¥æ¡†ç”¨çš„ä¸‰æ¬„æ’ç‰ˆ */
.weight-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr; /* ä¸‰å€‹ç­‰å¯¬æ¬„ä½ */
    gap: 10px;
    margin-bottom: 15px;
}

/* æ‰‹æ©Ÿç‰ˆç•«é¢è¼ƒçª„æ™‚ï¼Œè‡ªå‹•è®Šæˆç›´æ’ï¼Œæ¯”è¼ƒå¥½æŒ‰ */
@media (max-width: 600px) {
  .weight-inputs {
     grid-template-columns: 1fr;
  }
}

/* ------------------------------------ */

/* åŸæœ¬çš„ .row-split ä¿æŒä¸è®Šï¼Œç¹¼çºŒçµ¦ä¸‹æ–¹çš„ TDEE å€å¡Šä½¿ç”¨ */
.row-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
.row-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
.cal-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 14px;
}
.cal-row.total {
    font-weight: bold;
    color: var(--text-main);
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
}

/* ç´€éŒ„åˆ—è¡¨ */
.record-list {
    flex: 1;
    overflow-y: auto;
    max-height: 400px;
    padding-right: 5px;
}
.record-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px dashed #EBE5DE;
    font-size: 13px;
}
.delete-btn { width: auto; background: none; color: #ccc; padding: 0 5px; }

/* Loading */
#loading {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(255,255,255,0.8);
    display: none; justify-content: center; align-items: center; z-index: 99;
    color: var(--accent);
}
</style>
</head>
<body>

<div id="loading">Syncing...</div>

<div class="container">
    
<div class="card">
    <h2>Savings Bank</h2>
    
    <div class="weight-inputs">
        <div>
            <label>åˆå§‹ (Start)</label>
            <input type="number" id="startWeight" value="77" onchange="calcTotalGoal(); saveSettings();">
        </div>
        <div>
                <label style="color:var(--accent-hover);">ä»Šæ—¥ (Current)</label>
            <input type="number" id="currentWeight" placeholder="ä»Šæ—¥ç§¤é‡" onchange="saveSettings();" style="border: 1px solid var(--accent);">
        </div>
        <div>
            <label>ç›®æ¨™ (Goal)</label>
            <input type="number" id="targetWeight" value="55" style="font-weight:bold; color:var(--text-main);" onchange="calcTotalGoal(); saveSettings();">
        </div>
    </div>
    <div class="savings-box">
            <div class="goal-header">
                <div class="goal-title">ğŸ”¥ ç‡ƒç‡’é€²åº¦</div>
                <div class="goal-nums">
                    å·²å­˜ <span id="savedCal">0</span> / <span id="totalGoalCal">0</span> kcal
                </div>
            </div>
            <div class="big-progress-bg">
                <div class="big-progress-fill" id="longTermProgress"></div>
            </div>
            <div class="progress-badge" id="longTermPercent">0% å®Œæˆ</div>
            <p style="font-size:11px; color:var(--text-light); margin-top:8px; line-height:1.4;">
                *é‚è¼¯ï¼šæ¸›å»1å…¬æ–¤éœ€æ¶ˆè€— 7700 kcalã€‚<br>
                é€²åº¦æ¢æœƒæ ¹æ“šä½ æ¯å¤© (TDEE - æ”å–) çš„èµ¤å­—ç´¯ç©ã€‚
            </p>
        </div>

        <div class="daily-calc">
            <div class="row-split">
                <div>
                    <label>æ¯æ—¥ TDEE (ä»£è¬)</label>
                    <input type="number" id="tdee" value="1350" placeholder="åŸºç¤ä»£è¬" onchange="updateDailyAndSave()">
                </div>
                <div>
                    <label>ä»Šæ—¥å·²åƒ</label>
                    <input type="number" id="todayEaten" value="0" disabled>
                </div>
            </div>
            <div class="cal-row total">
                <span>ä»Šæ—¥å­˜æ¬¾ (Deficit)</span>
                <span id="todayDeficit">0</span>
            </div>
            <div style="font-size:11px; color:#aaa; margin-top:4px;">æ­£æ•¸ä»£è¡¨ä»Šæ—¥è®Šç˜¦ï¼Œè² æ•¸ä»£è¡¨è®Šèƒ–</div>
        </div>
    </div>

    <div class="card">
        <h2>Add Food</h2>
        <label>Food Name</label>
        <input type="text" id="foodName" placeholder="è¼¸å…¥é£Ÿç‰©åç¨±" onblur="autoSearch()">
        
        <label>Calories</label>
        <input type="number" id="foodCal" placeholder="kcal">
        
        <button onclick="addRecord()">ï¼‹ Add Record</button>
        <button onclick="googleSearch()" style="background:transparent; color:#999; border:1px solid #eee; margin-top:10px;">ğŸ” Google Check</button>
    </div>

    <div class="card">
        <h2>History</h2>
        <div class="record-list" id="recordList">Loading...</div>
    </div>

</div>

<script>
// ğŸ”¥ è«‹å°‡ä½ çš„ Web App URL è²¼åœ¨é€™è£¡
const API_URL = "https://script.google.com/macros/s/AKfycbzs4l4E4kxTxxBicnuHSgKo7zb1gMyC-hBnHKBoFW9Hpol1kOuQM8cc32C34fjXepiy/exec";

// UI Elements
const els = {
    startW: document.getElementById('startWeight'),
currentW: document.getElementById('currentWeight'), 
    targetW: document.getElementById('targetWeight'),
    tdee: document.getElementById('tdee'),
    savedCal: document.getElementById('savedCal'),
    totalGoalCal: document.getElementById('totalGoalCal'),
    longTermProgress: document.getElementById('longTermProgress'),
    longTermPercent: document.getElementById('longTermPercent'),
    todayEaten: document.getElementById('todayEaten'),
    todayDeficit: document.getElementById('todayDeficit'),
    foodName: document.getElementById('foodName'),
    foodCal: document.getElementById('foodCal'),
    recordList: document.getElementById('recordList'),
    loading: document.getElementById('loading')
};


// 1. åˆå§‹åŒ– (å‡ç´šç‰ˆï¼šå…ˆè®€å¿«å–ï¼Œå†è®€é›²ç«¯)
async function init() {
    // A. å…ˆè®€æœ¬åœ°å¿«å– (è®“ç•«é¢é¦¬ä¸Šå‡ºä¾†ï¼Œä¸ç”¨ç­‰)
    const saved = JSON.parse(localStorage.getItem('bowbow_settings'));
    if (saved) {
        if(saved.startW) els.startW.value = saved.startW;
        if(saved.currentW) els.currentW.value = saved.currentW;
        if(saved.targetW) els.targetW.value = saved.targetW;
        if(saved.tdee) els.tdee.value = saved.tdee;
        calcTotalGoal(); // å…ˆç®—ä¸€æ¬¡
    }

    // B. æ¥è‘—å»é›²ç«¯æŠ“æœ€æ–°çš„ (å¦‚æœæœ‰ä¸åŒæ­¥çš„ï¼Œé€™è£¡æœƒæ›´æ–°)
    // é€™è£¡æˆ‘å€‘ä¸é¡¯ç¤ºå…¨å± loadingï¼Œå·å·åœ¨èƒŒæ™¯æ›´æ–°å°±å¥½
    try {
        const cloudSettings = await callApi({ action: "getSettings" });
        if (cloudSettings && cloudSettings.start) {
            els.startW.value = cloudSettings.start;
            els.currentW.value = cloudSettings.current;
            els.targetW.value = cloudSettings.target;
            els.tdee.value = cloudSettings.tdee;
            
            // æ›´æ–°æœ¬åœ°å¿«å–ï¼Œç¢ºä¿ä¸‹æ¬¡ä¹Ÿæ˜¯æœ€æ–°çš„
            localStorage.setItem('bowbow_settings', JSON.stringify({
                startW: cloudSettings.start,
                currentW: cloudSettings.current,
                targetW: cloudSettings.target,
                tdee: cloudSettings.tdee
            }));
            
            calcTotalGoal(); // é›²ç«¯è³‡æ–™å›ä¾†å¾Œï¼Œå†é‡ç®—ä¸€æ¬¡
            console.log("å·²å¾é›²ç«¯åŒæ­¥è¨­å®š â˜ï¸");
        }
    } catch(e) {
        console.log("é›²ç«¯è¨­å®šè®€å–å¤±æ•— (å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨)");
    }

    loadRecords(); 
}

// 3. å„²å­˜è¨­å®š (å‡ç´šç‰ˆï¼šåŒæ™‚å­˜æœ¬åœ° + é›²ç«¯)
function saveSettings() {
    const data = {
        start: els.startW.value,
        current: els.currentW.value,
        target: els.targetW.value,
        tdee: els.tdee.value
    };

    // A. å­˜æœ¬åœ°
    localStorage.setItem('bowbow_settings', JSON.stringify({
        startW: data.start,
        currentW: data.current,
        targetW: data.target,
        tdee: data.tdee
    }));

    // B. å­˜é›²ç«¯ (éåŒæ­¥å‘¼å«ï¼Œä¸ç”¨ç­‰å®ƒå›ä¾†)
    // æ³¨æ„ï¼šç‚ºäº†é¿å…ä½ æ¯æ‰“ä¸€å€‹å­—å°±å‘¼å«ä¸€æ¬¡ APIï¼Œæˆ‘å€‘å¯ä»¥ç°¡å–®åšå€‹ä¿è­·ï¼Œä½†é€™è£¡ç›´æ¥å‘¼å«ä¹Ÿç„¡å¦¨ï¼ŒGoogle Sheet é ‚å¾—ä½
// B. å­˜é›²ç«¯
callApi({ 
    action: "saveSettings", 
    start: data.start, 
    current: data.current, 
    target: data.target, 
    tdee: data.tdee 
}, false); 

// 4. API å‘¼å« (å„ªåŒ–ç‰ˆï¼šæ”¯æ´èƒŒæ™¯åŸ·è¡Œ)
async function callApi(payload, showLoading = true) {
    // åªæœ‰ç•¶ showLoading ç‚º true æ™‚ï¼Œæ‰é¡¯ç¤ºé®ç½©
    if (showLoading) els.loading.style.display = "flex";
    
    try {
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        });
        return await res.json();
    } catch (e) {
        console.error(e);
        // èƒŒæ™¯åŸ·è¡Œæ™‚å°±ä¸å½ˆå‡ºæƒ±äººçš„ alertï¼Œåªåœ¨ console å ±éŒ¯
        if (showLoading) alert("é€£ç·šéŒ¯èª¤"); 
    } finally {
        // ä¸ç®¡æˆåŠŸå¤±æ•—ï¼Œéƒ½è¦é—œé–‰é®ç½©
        if (showLoading) els.loading.style.display = "none";
    }
}

// 5. è¼‰å…¥ç´€éŒ„èˆ‡è¨ˆç®—ç´¯ç©å„²è“„
// 5. è¼‰å…¥ç´€éŒ„èˆ‡è¨ˆç®—ç´¯ç©å„²è“„ (ä¿®æ­£æ™‚å€å•é¡Œç‰ˆ)
async function loadRecords() {
    // A. è¼‰å…¥åˆ—è¡¨
    const data = await callApi({ action: "getRecords" });
    
    let todayTotal = 0;

    // ğŸ”¥ ä¿®æ­£é‡é»é–‹å§‹ï¼šå–å¾—ã€Œæœ¬åœ°ã€ä»Šæ—¥çš„æ—¥æœŸç‰©ä»¶ï¼Œä¸¦å°‡æ™‚é–“æ­¸é›¶
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0); // è¨­å®šç‚ºä»Šå¤©å‡Œæ™¨ 00:00:00
    const todayEnd = new Date();
    todayEnd.setHours(23, 59, 59, 999); // è¨­å®šç‚ºä»Šå¤©æ™šä¸Š 23:59:59
    // ğŸ”¥ ä¿®æ­£é‡é»çµæŸ
    
    els.recordList.innerHTML = "";
    if (Array.isArray(data)) {
        data.forEach(item => {
            // å°‡å¾Œç«¯å›å‚³çš„æ—¥æœŸå­—ä¸²è½‰ç‚º Date ç‰©ä»¶
            const itemDate = new Date(item.date);

            // åˆ¤æ–·è©²ç´€éŒ„çš„æ™‚é–“æ˜¯å¦è½åœ¨ã€Œä»Šå¤©ã€çš„ç¯„åœå…§
            if (itemDate >= todayStart && itemDate <= todayEnd) {
                todayTotal += Number(item.calories);
            }
            
            // æ¸²æŸ“åˆ—è¡¨ (é¡¯ç¤ºæ—¥æœŸï¼Œåªå–å‰10å€‹å­—å…ƒ yyyy-mm-dd)
            let dateDisplay = item.date;
            try {
                // å˜—è©¦è½‰æˆæ¯”è¼ƒå¥½çœ‹çš„æœ¬åœ°æ—¥æœŸæ ¼å¼
                dateDisplay = new Date(item.date).toLocaleDateString();
            } catch(e) {
                dateDisplay = item.date.substring(0, 10);
            }

            els.recordList.innerHTML += `
                <div class="record-item">
                    <div>
                        <div style="font-weight:500;">${item.item}</div>
                        <div style="font-size:11px; color:#ccc;">${dateDisplay}</div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span style="color:var(--accent-hover); font-weight:500; margin-right:5px;">${item.calories}</span>
                        <button class="delete-btn" onclick="deleteRecord('${item.id}')">Ã—</button>
                    </div>
                </div>`;
        });
    }
    
    // æ›´æ–°ä»‹é¢é¡¯ç¤º
    els.todayEaten.value = todayTotal;
    updateDailyAndSave(false); // æ›´æ–°ä»Šæ—¥èµ¤å­—é¡¯ç¤º

    // B. è«‹å¾Œç«¯è¨ˆç®—ã€Œæ­·å²ç¸½èµ¤å­—ã€
    const stats = await callApi({ 
        action: "calcSavings", 
        tdee: els.tdee.value 
    });
    
    if (stats && stats.totalSaved !== undefined) {
        updateLongTermProgress(stats.totalSaved);
    }
}
            
            // æ¸²æŸ“åˆ—è¡¨
            els.recordList.innerHTML += `
                <div class="record-item">
                    <span>${item.item} <small style="color:#ccc">(${item.calories})</small></span>
                    <button class="delete-btn" onclick="deleteRecord('${item.id}')">Ã—</button>
                </div>`;
        });
    }
    
    els.todayEaten.value = todayTotal;
    updateDailyAndSave(false); // æ›´æ–°ä»Šæ—¥èµ¤å­—é¡¯ç¤º

    // B. è«‹å¾Œç«¯è¨ˆç®—ã€Œæ­·å²ç¸½èµ¤å­—ã€
    // å‚³é€ TDEE çµ¦å¾Œç«¯ï¼Œè®“å®ƒå»ç®—æ¯å¤©çœå¤šå°‘
    const stats = await callApi({ 
        action: "calcSavings", 
        tdee: els.tdee.value 
    });
    
    if (stats && stats.totalSaved !== undefined) {
        updateLongTermProgress(stats.totalSaved);
    }
}

function updateDailyAndSave(shouldReload = true) {
    const tdee = parseInt(els.tdee.value) || 1350;
    const eaten = parseInt(els.todayEaten.value) || 0;
    const deficit = tdee - eaten;
    
    els.todayDeficit.textContent = deficit;
    els.todayDeficit.style.color = deficit >= 0 ? "#C9B29C" : "#c0392b";
    
    if(shouldReload) saveSettings();
}

function updateLongTermProgress(savedAmount) {
    // å–å¾—ç¸½ç›®æ¨™
    const totalGoal = parseInt(els.totalGoalCal.textContent.replace(/,/g, '')) || 1;
    
    // æ›´æ–°æ•¸å­—
    els.savedCal.textContent = savedAmount.toLocaleString();
    
    // è¨ˆç®—ç™¾åˆ†æ¯”
    let percent = (savedAmount / totalGoal) * 100;
    percent = Math.min(100, Math.max(0, percent)); // 0~100
    
    els.longTermProgress.style.width = percent + "%";
    els.longTermPercent.textContent = percent.toFixed(1) + "% å®Œæˆ";
}

// å…¶é¤˜åŠŸèƒ½ï¼šæ–°å¢ã€æœå°‹ã€åˆªé™¤
async function addRecord() {
    const name = els.foodName.value;
    const cal = els.foodCal.value;
    if(!name || !cal) return alert("è«‹è¼¸å…¥å®Œæ•´");
    
    await callApi({ action: "addRecord", item: name, calories: cal });
    els.foodName.value = ""; els.foodCal.value = "";
    loadRecords();
}

async function autoSearch() {
    const name = els.foodName.value;
    if(!name) return;
    if(els.foodCal.value) return; 
    
    const res = await callApi({ action: "searchFood", item: name });
    if(res.calories) {
        els.foodCal.value = res.calories;
        els.foodCal.style.background = "#fff";
        setTimeout(()=>els.foodCal.style.background="", 300);
    }
}

async function deleteRecord(id) {
    if(!confirm("åˆªé™¤æ­¤ç­†?")) return;
    await callApi({ action: "deleteRecord", id: id });
    loadRecords();
}

function googleSearch() {
    const val = els.foodName.value;
    if(val) window.open(`https://www.google.com/search?q=${val}+ç†±é‡`);
}

window.onload = init;
</script>

</body>
</html>